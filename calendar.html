<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch làm việc</title>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- CSS chung (giả sử bạn có file này) -->
    <link rel="stylesheet" href="nhanvien_trangchu.css">

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f4f6f9;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            margin-left: 500px;
             justify-content: space-between;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: #3498db;
            color: white;
            padding: 15px;
            border-radius: 8px;
           
        }

        .calendar {
            justify-content: space-between;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background: #3498db;
            color: white;
        }

        td:hover {
            background: #eaf4fc;
            cursor: pointer;
        }

        .today {
            background: #ffeb3b !important;
            font-weight: bold;
            color: #000 !important;
        }

        .event {
            background: #e8f5e9;
            position: relative;
        }

        .event::after {
            content: "●";
            color: #4caf50;
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
        }

        .user-info {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto 10px;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>

<body>

    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            
                <h2>Nhân Viên</h2>
                <p>Hệ thống quản lý</p>
             
            <div class="user-info" style="display: none;">
                <div class="user-avatar" id="user-avatar">NV</div>
                <h3 id="user-name">Đang tải...</h3>
                <p id="user-position" style="margin:5px 0; color:#bdc3c7;">Nhân viên</p>
            </div>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="nhanvien_trangchu.html"><i class="fas fa-home"></i> <span>Trang chủ</span></a></li>
                <li><a href="profile_nhanvien.html"><i class="fas fa-user"></i> <span>Thông tin cá nhân</span></a></li>
                <li><a href="nhanvien_chamcong.html"><i class="fas fa-calendar-alt"></i> <span>Chấm công</span></a></li>
                <li><a href="nhanvien_thoigianlamviec.html"><i class="fas fa-clock"></i> <span>Thời gian làm
                            việc</span></a></li>
                <li class="active"><a href="calendar.html"><i class="fas fa-calendar-day"></i> <span>Lịch làm
                            việc</span></a></li>
                <li><a href="salary.html"><i class="fas fa-file-invoice-dollar"></i> <span>Lương & Phúc lợi</span></a>
                </li>
                <li><a href="finance.html"><i class="fas fa-piggy-bank"></i> <span>Tài chính cá nhân</span></a></li>
                <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> <span>Đăng xuất</span></a></li>
            </ul>
        </nav>
    </div>

    <div class="container">
        <h1><i class="fas fa-calendar-day"></i> Lịch làm việc</h1>

        <div class="calendar-header">
            <button onclick="prevMonth()"><i class="fas fa-chevron-left"></i></button>
            <h2 id="monthYear">Tháng 11 / 2025</h2>
            <button onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="calendar">
            <table id="calendarTable">
                <thead>
                    <tr>
                        <th>CN</th>
                        <th>T2</th>
                        <th>T3</th>
                        <th>T4</th>
                        <th>T5</th>
                        <th>T6</th>
                        <th>T7</th>
                    </tr>
                </thead>
                <tbody id="calendarBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ==================== KIỂM TRA ĐĂNG NHẬP & THÔNG TIN USER ====================
        let currentUser = null;

        function checkAuthentication() {
            const userData = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const token = localStorage.getItem('session_token');

            if (!userData || !token) {
                Swal.fire('Chưa đăng nhập', 'Vui lòng đăng nhập để tiếp tục', 'warning').then(() => {
                    window.location.href = 'login.html';
                });
                return false;
            }

            // Chỉ cho nhân viên truy cập
            const allowedRoles = ['employee', 'nhanvien', 'staff'];
            if (!allowedRoles.includes(userData.role)) {
                window.location.href = 'qlns.html'; // hoặc trang quản lý
                return false;
            }

            currentUser = userData;
            updateUserInfo();
            return true;
        }

        function updateUserInfo() {
            if (!currentUser) return;

            const userNameEl = document.getElementById('user-name');
            const userPositionEl = document.getElementById('user-position');
            const userAvatarEl = document.getElementById('user-avatar');

            const fullName = currentUser.full_name || currentUser.name || currentUser.username || 'Nhân viên';
            userNameEl.textContent = fullName;

            const roleDisplay = {
                'employee': 'Nhân viên', 'nhanvien': 'Nhân viên', 'staff': 'Nhân viên'
            };
            userPositionEl.textContent = roleDisplay[currentUser.role] || 'Nhân viên';

            // Avatar
            if (currentUser.avatar_url || currentUser.picture) {
                userAvatarEl.innerHTML = `<img src="${currentUser.avatar_url || currentUser.picture}" alt="Avatar">`;
            } else {
                const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                userAvatarEl.textContent = initials;
            }
        }

        // ==================== ĐĂNG XUẤT ====================
        async function logout() {
            const confirmResult = await Swal.fire({
                title: 'Xác nhận đăng xuất',
                text: 'Bạn có chắc chắn muốn đăng xuất?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Đăng xuất',
                cancelButtonText: 'Hủy'
            });

            if (!confirmResult.isConfirmed) return;

            Swal.fire({ title: 'Đang đăng xuất...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const sessionToken = localStorage.getItem('session_token');
            if (sessionToken) {
                try {
                    await fetch('http://localhost/unitop-php/logout.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_token: sessionToken })
                    });
                } catch (e) { console.warn('Logout API lỗi (vẫn đăng xuất client)', e); }
            }

            localStorage.removeItem('currentUser');
            localStorage.removeItem('session_token');

            Swal.fire({ icon: 'success', title: 'Đăng xuất thành công!', timer: 1500, showConfirmButton: false })
                .then(() => window.location.href = 'login.html');
        }

        // Gắn sự kiện logout
        document.getElementById('logout-btn')?.addEventListener('click', e => {
            e.preventDefault();
            logout();
        });

        // ==================== LỊCH LÀM VIỆC ====================
        const date = new Date();
        let currentMonth = date.getMonth();
        let currentYear = date.getFullYear();

        const events = {
            "2025-11-28": "Họp toàn công ty",
            "2025-11-15": "Team building Q4",
            "2025-12-25": "Nghỉ lễ Giáng sinh",
            "2025-12-31": "Tổng kết cuối năm"
        };

        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            document.getElementById("monthYear").textContent = `Tháng ${currentMonth + 1} / ${currentYear}`;

            let html = "";
            let day = 1;

            for (let i = 0; i < 6; i++) {
                html += "<tr>";
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < firstDay) {
                        html += "<td></td>";
                    } else if (day > daysInMonth) {
                        html += "<td></td>";
                    } else {
                        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const todayStr = new Date().toISOString().slice(0, 10);
                        const isToday = dateStr === todayStr ? "today" : "";
                        const hasEvent = events[dateStr] ? "event" : "";
                        html += `<td class="${isToday} ${hasEvent}" title="${events[dateStr] || ''}">
                      ${day}<br><small style="color:#27ae60;">${events[dateStr] || ""}</small>
                     </td>`;
                        day++;
                    }
                }
                html += "</tr>";
                if (day > daysInMonth) break;
            }
            document.getElementById("calendarBody").innerHTML = html;
        }

        function prevMonth() { currentMonth--; if (currentMonth < 0) { currentMonth = 11; currentYear--; } renderCalendar(); }
        function nextMonth() { currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; } renderCalendar(); }

        // ==================== KHỞI ĐỘNG ====================
        document.addEventListener('DOMContentLoaded', function () {
            if (!checkAuthentication()) return;
            renderCalendar();
        });
    </script>
</body>

</html>